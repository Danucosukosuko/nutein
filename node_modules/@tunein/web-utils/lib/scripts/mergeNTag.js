import { getExistingReleaseBranch } from './getExistingReleaseBranch';
import * as releaseUtils from './releaseUtils';
export function mergeNTag(execSync, prompt) {
    execSync('git fetch -p', { stdio: 'inherit' });
    const mainBranch = releaseUtils.getMainBranchName(execSync);
    let branchToMerge;
    try {
        branchToMerge = getExistingReleaseBranch(execSync, prompt);
    }
    catch (e) {
        console.log('There is no release/hotfix branch to merge!');
        process.exit(1);
    }
    let semver;
    try {
        semver = branchToMerge.match(/\d+\.\d+\.\d+/)[0];
    }
    catch (e) {
        console.log('Invalid release number. Please proceed manually.');
        process.exit(1);
    }
    const answer = prompt(`
  Gearing up to merge n tag "${branchToMerge}". Ok to proceed?

  Type 'yes' or 'no': `);
    if (answer !== 'yes') {
        console.log("Quitting! Come back when you're ready!");
        process.exit(1);
    }
    console.log(`Merging "${branchToMerge}" into develop...`);
    execSync('git checkout develop');
    execSync('git pull');
    execSync(`git merge --no-ff origin/${branchToMerge}`);
    execSync('git push --no-verify origin develop');
    console.log('...done!');
    console.log(`Merging "${branchToMerge}" into ${mainBranch}...`);
    execSync(`git checkout ${mainBranch}`);
    execSync('git pull');
    execSync(`git merge --no-ff origin/${branchToMerge}`);
    execSync(`git push --no-verify origin ${mainBranch}`);
    console.log('...done!');
    console.log(`Creating tag "${semver}"...`);
    execSync(`git tag ${semver}`);
    execSync(`git push --no-verify origin ${semver}`);
    console.log('...done!');
    console.log(`Killing "${branchToMerge}"...`);
    execSync(`git push --no-verify origin :${branchToMerge}`);
    console.log('...killed X-o');
    console.log("Consider yourself merged 'n tagged");
}
